<!DOCTYPE html>
<html>
<head>
<style>
    .framecontrols select
    {
        width: 15em;
        display: inline-block;
        position:relative;
    }
    .bigtext
    {
        width: 100%;
        height: 15em;
    }
    .biggertext
    {
        width: 100%;
        height: 30em;
    }
</style>
</head>
<body>
<script src="Animation.js"></script>
<script>
window.vecSprite = null;
window.sprite = 
{
    "idle":[
        [
            {   "time": 0.0,
                "rotation": 0,
                "fill": "#FF0000",
                "path": "m 0 0 l 0 100 l 100 0 l 0 -100 l -100 0 z"
            },
            {
                "time": 1.7,
                "rotation": 90,
                "fill": "#FFFF00",
                "path": "m 0 0 l 0 100 l 150 50 l -50 -150 l -100 0 z"
            },
            {
                "time": 3.4,
                "rotation": 180,
                "fill": "#00FFFF",
                "path": "m 0 0 l 0 100 l 100 0 l 0 -100 l -100 0 z"
            },
            {
                "time": 5.1,
                "rotation": 270,
                "fill": "#FF00FF",
                "path": "m 0 0 l -50 150 l 150 -50 l 0 -100 l -100 0 z"
            },
            {   "time": 6.8,
                "rotation": 360,
                "fill": "#FF0000",
                "path": "m 0 0 l 0 100 l 100 0 l 0 -100 l -100 0 z"
            },
        ]   
        
    ]
};
function draw(ts)
{
    if(window.ts==null)
    {
        window.ts = ts;
    }
    let dT= (ts-window.ts)/1000;
    //let a = window.vecSprite.animations[window.sel_a.value];
    //a.update(dT);
    if(!window.paused)
        window.vecSprite.update(dT);
    window.ctx.resetTransform();
    window.ctx.clearRect(0,0,400,400);
    window.ctx.translate(200,200);
    window.vecSprite.draw(window.ctx);
    window.ts = ts;
    
    window.scrubber.max=window.vecSprite.getLength();
    window.scrubber.value=window.vecSprite.getTime();
    let rnd = window.vecSprite.getTime()*10;
    rnd = Math.round(rnd);
    rnd/=10;
    window.scrubtime.innerText = rnd + "/" + window.vecSprite.getLength();
    requestAnimationFrame(draw);
}

function setTime(t)
{

}

function toVecAnimation()
{
    window.vecSprite = VectorSprite.fromRawObject(window.sprite);
    document.getElementById("output").value = JSON.stringify(window.sprite,null,"\t");
}

function loadFromText()
{
    window.sprite=JSON.parse(document.getElementById("output").value);
    toVecAnimation();
    reloadGUI();
}

function reloadGUI()
{   
    window.sel_a.innerHTML="";
    for(const [key, value] of Object.entries(window.vecSprite.animations)) 
    {
        let opt = document.createElement("option");
        opt.append(key);
        window.sel_a.appendChild(opt);
    }
    window.sel_a.selectedIndex=0;
    window.sel_a.dispatchEvent(new Event("change"));
    /*/
    window.sel_p.selectedIndex=0;
    window.sel_p.dispatchEvent(new Event("change"));
    window.sel_f.selectedIndex=0;
    window.sel_f.dispatchEvent(new Event("change"));
    //*/
}
function loadGUI()
{
    window.paused=false;
    window.sel_a.addEventListener("change",(e)=>{
        window.sel_p.innerHTML="";
        for(let i=0;i<window.sprite[window.sel_a.value].length;i++)
        {
            let opt = document.createElement("option");
            opt.append(i);
            window.sel_p.appendChild(opt);
        }
        window.sel_p.selectedIndex=0;
        window.sel_p.dispatchEvent(new Event("change"));
    });
    window.sel_p.addEventListener("change",(e)=>{
        window.sel_f.innerHTML="";
        for(let i=0;i<window.sprite[window.sel_a.value][window.sel_p.value].length;i++)
        {
            let opt = document.createElement("option");
            opt.append(i);
            window.sel_f.appendChild(opt);
        }
        window.sel_f.selectedIndex=0;
        window.sel_f.dispatchEvent(new Event("change"));
    });
    window.sel_f.addEventListener("change",(e)=>{
        for(let i=0;i<window.sprite[window.sel_a.value].length;i++)
        {
            let pframe = window.sprite[window.sel_a.value][window.sel_p.value][window.sel_f.value];
            window.pathbox.value = pframe.path;
            window.pathtime.value = pframe.time;
            window.pathrot.value = pframe.rotation;
            window.pathfill.value = pframe.fill;
            window.vecSprite.play(window.sel_a.value);
            window.vecSprite.setTime(pframe.time);
        }
    });
    window.scrubber.addEventListener("input",(e)=>{
        window.vecSprite.setTime(window.scrubber.value);
    });
    window.pathbox.addEventListener("input",(e)=>{
        window.sprite[window.sel_a.value][window.sel_p.value][window.sel_f.value].path=window.pathbox.value;
        toVecAnimation();
    });
    window.pathrot.addEventListener("input",(e)=>{
        window.sprite[window.sel_a.value][window.sel_p.value][window.sel_f.value].rotation=window.pathrot.value;
        toVecAnimation();
    });
    window.pathfill.addEventListener("input",(e)=>{
        window.sprite[window.sel_a.value][window.sel_p.value][window.sel_f.value].fill=window.pathfill.value;
        toVecAnimation();
    });
    window.pathtime.addEventListener("input",(e)=>{
        window.sprite[window.sel_a.value][window.sel_p.value][window.sel_f.value].time=window.pathtime.value;
        toVecAnimation();
    });
}



</script>
<canvas width="400" height="400" id="view"></canvas><br />
<input type="range" min="0" max="1" step="0.1" id="scrubber" width="300" /><button onclick="window.paused=!window.paused">*</button><span id="scrubtime"></span><br />
Time: <input type="number" id="frametime" step="0.1" /> 
Rotation: <input type="number" id="framerot" step="1" />
Fill: <input type="color" id="framefill" /><br /><textarea class="bigtext" id="currentpath" ></textarea>
<div>
    <input id="newAnimName" />
    <button onclick="addAnimation()";>New animation</button>
    <button onclick="addPath()";>New path</button>
    <button onclick="addFrame()";>New frame</button>
</div>
<div class="framecontrols">
    <select id="animations" size="10">
    </select>
    <select id="paths" size="10">
    </select>
    <select id="frames" size="10">
    </select>
</div>
<textarea class="biggertext" id="output" ></textarea>
<button onclick="loadFromText()">Reload</button>
<script>
window.ctx = document.getElementById("view").getContext("2d");
window.sel_a = document.getElementById("animations");
window.sel_p = document.getElementById("paths");
window.sel_f = document.getElementById("frames");
window.pathbox = document.getElementById("currentpath");
window.pathtime = document.getElementById("frametime");
window.pathrot = document.getElementById("framerot");
window.pathfill = document.getElementById("framefill");
window.scrubber = document.getElementById("scrubber");

//console.log(window.stored);
toVecAnimation();
loadGUI();
reloadGUI();
console.log(window.vecSprite);
requestAnimationFrame(draw);
/*
let paths = [];
window.stored["frames"].forEach((f)=>{paths.push(f['path'])});
console.log(paths);
let chunked = [];
paths.forEach((p)=>{chunked.push(chunk(p))});
console.log(chunked);
let done = diff(chunked);
console.log(done);
window.stored["frames"].forEach((f,i)=>{
    f['path']=done[0];
    f['values'] = done[1][i];
    });
//
console.log(window.stored["frames"]);
//*/
</script>
</body>
</html>